{% extends 'admin/base.html' %}

{% load static %}
{% load unfold %}
{% load django_cfg %}

{% block extrahead %}
    {{ block.super }}
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'admin/css/dashboard.css' %}">
    <style>
        /* Make content container full height and full width */
        #content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Remove container centering and width limits */
        #content.container,
        #content.mx-auto,
        #content .mx-auto {
            margin-left: 0 !important;
            margin-right: 0 !important;
            max-width: none !important;
        }

        /* Also remove from unfold container component and make it full height */
        #content > .mx-auto {
            margin-left: 0 !important;
            margin-right: 0 !important;
            max-width: none !important;
            height: 100%;
        }

        /* Remove horizontal padding on mobile for @container */
        @media (max-width: 768px) {
            div[class*="@container"].px-4 {
                padding-left: 0 !important;
                padding-right: 0 !important;
            }
        }

        /* Make Alpine tabs wrapper full height */
        #content [x-data] {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Make tab content blocks full height */
        #content [x-data] > div[x-show] {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .nextjs-dashboard-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .nextjs-dashboard-iframe.loaded {
            visibility: visible;
            opacity: 1;
        }

        .iframe-container {
            position: relative;
            background: transparent;
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(209, 213, 219, 0.2);
            border-radius: 0.375rem; /* rounded-md */
            overflow: hidden;
            min-height: 400px;
        }

        /* On mobile, use more screen space */
        @media (max-width: 768px) {
            .iframe-container {
                min-height: calc(100vh - 200px);
            }
        }

        .dark .iframe-container {
            border-color: rgba(75, 85, 99, 0.2);
        }

        .iframe-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1;
        }

        .iframe-loading.hidden {
            display: none;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Hide elements when Alpine x-cloak is active */
        [x-cloak] { display: none !important; }
    </style>
{% endblock %}

{% block breadcrumbs %}{% endblock %}

{% block coltype %}{% endblock %}

{% block title %}
    {% if subtitle %}{{ subtitle }} | {% endif %}
    {{ title }} | {{ site_title|default:'Django site admin' }}
{% endblock %}

{% block branding %}
    {% include "unfold/helpers/site_branding.html" %}
{% endblock %}

{% block content %}
    <!-- Main Container -->
    {% component "unfold/components/container.html" %}
        <div x-data="{
            activeTab: 'builtin',
            previousTab: 'builtin',
            currentNextjsPath: '',
            switchTab(tab) {
                if (this.previousTab !== tab) {
                    // Reset iframe to initial URL when switching tabs
                    this.resetIframe(this.previousTab);
                    this.previousTab = tab;
                }
                this.activeTab = tab;
            },
            resetIframe(tab) {
                // Reset the iframe that was just hidden
                let iframeId;
                if (tab === 'builtin') {
                    iframeId = 'nextjs-dashboard-iframe-builtin';
                } else if (tab === 'nextjs') {
                    iframeId = 'nextjs-dashboard-iframe-nextjs';
                } else if (tab === 'docs') {
                    iframeId = 'nextjs-dashboard-iframe-docs';
                }

                const iframe = document.getElementById(iframeId);
                if (iframe) {
                    const originalSrc = iframe.getAttribute('data-original-src') || iframe.src;
                    iframe.src = originalSrc;
                }
                // Reset path when resetting iframe
                if (tab === 'nextjs') {
                    this.currentNextjsPath = '';
                }
            },
            openInNewWindow() {
                // Get iframe ID based on active tab
                let iframeId;
                if (this.activeTab === 'builtin') {
                    iframeId = 'nextjs-dashboard-iframe-builtin';
                } else if (this.activeTab === 'nextjs') {
                    iframeId = 'nextjs-dashboard-iframe-nextjs';
                } else if (this.activeTab === 'docs') {
                    iframeId = 'nextjs-dashboard-iframe-docs';
                }

                const iframe = document.getElementById(iframeId);
                if (!iframe) return;

                // Get base URL from iframe src or data-original-src
                let baseUrl = iframe.src || iframe.getAttribute('data-original-src');

                // If we have a tracked path from postMessage (only for nextjs tab), use it
                if (this.activeTab === 'nextjs' && this.currentNextjsPath) {
                    try {
                        const url = new URL(baseUrl);
                        // Replace pathname with tracked path
                        url.pathname = this.currentNextjsPath;
                        baseUrl = url.toString();
                    } catch (e) {
                        console.warn('[Django-CFG] Failed to construct URL with path:', e);
                    }
                }

                if (baseUrl) {
                    window.open(baseUrl, '_blank', 'noopener,noreferrer');
                }
            }
        }">
            {% if is_frontend_dev_mode %}
            <!-- Development Mode Badge -->
            <div class="bg-yellow-100 dark:bg-yellow-900 border-l-4 border-yellow-500 text-yellow-700 dark:text-yellow-300" role="alert">
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <div>
                        <p class="font-bold">Frontend Development Mode Active</p>
                        <p class="text-sm">Loading Next.js from <code class="bg-yellow-200 dark:bg-yellow-800 px-1 rounded">{% nextjs_admin_url %}</code></p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Tab Navigation -->
            {% has_nextjs_external_admin as is_external_enabled %}
            {% if is_external_enabled %}
            <div>
                <div class="border-b border-gray-300 dark:border-gray-600" style="border-bottom-color: rgba(209, 213, 219, 0.2);">
                    <style>
                        .dark [style*="border-bottom-color"] {
                            border-bottom-color: rgba(75, 85, 99, 0.2) !important;
                        }

                        /* Mobile: Scrollable tabs */
                        .tabs-container {
                            overflow-x: auto;
                            -webkit-overflow-scrolling: touch;
                            scrollbar-width: thin;
                            scrollbar-color: rgba(156, 163, 175, 0.3) transparent;
                        }

                        .tabs-container::-webkit-scrollbar {
                            height: 4px;
                        }

                        .tabs-container::-webkit-scrollbar-track {
                            background: transparent;
                        }

                        .tabs-container::-webkit-scrollbar-thumb {
                            background-color: rgba(156, 163, 175, 0.3);
                            border-radius: 2px;
                        }

                        .tabs-container::-webkit-scrollbar-thumb:hover {
                            background-color: rgba(156, 163, 175, 0.5);
                        }
                    </style>
                    <div class="tabs-container">
                        <div class="flex items-center justify-between px-4 min-w-max">
                            <nav class="-mb-px flex space-x-2 sm:space-x-4 md:space-x-8" aria-label="Dashboard Tabs">
                        <button @click="switchTab('builtin')"
                                class="whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm flex items-center gap-2 transition-all duration-200"
                                :class="activeTab === 'builtin'
                                    ? 'border-primary-600 text-primary-600 dark:border-primary-500 dark:text-primary-500'
                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-700'">
                            <span class="material-icons text-base">dashboard</span>
                            <span class="hidden sm:inline">Built-in Dashboard</span>
                            <span class="sm:hidden">Built-in</span>
                        </button>

                        <button @click="switchTab('nextjs')"
                                class="whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm flex items-center gap-2 transition-all duration-200"
                                :class="activeTab === 'nextjs'
                                    ? 'border-primary-600 text-primary-600 dark:border-primary-500 dark:text-primary-500'
                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-700'">
                            <span class="material-icons text-base">web</span>
                            <span class="hidden sm:inline">{% nextjs_external_admin_title %}</span>
                            <span class="sm:hidden">Admin</span>
                        </button>

                        <button @click="switchTab('docs')"
                                class="whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm flex items-center gap-2 transition-all duration-200"
                                :class="activeTab === 'docs'
                                    ? 'border-primary-600 text-primary-600 dark:border-primary-500 dark:text-primary-500'
                                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-700'">
                            <span class="material-icons text-base">description</span>
                            <span>Docs</span>
                        </button>
                            </nav>

                            <!-- Actions & Version info -->
                            <div class="flex items-center gap-2 md:gap-4 py-4">
                                <!-- Open in new window button (available for all tabs) -->
                                <button @click="openInNewWindow()"
                                        title="Open in new window"
                                        class="flex items-center gap-1.5 px-2 md:px-3 py-1.5 text-xs font-medium rounded-md text-gray-600 hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-gray-100 dark:hover:bg-gray-700 transition-all duration-150 whitespace-nowrap">
                                    <span class="material-icons" style="font-size: 16px;">open_in_new</span>
                                    <span class="hidden sm:inline">Open in New Window</span>
                                </button>

                                <!-- Version info -->
                                <div class="text-xs text-gray-400 dark:text-gray-500 hidden md:block">
                                    {% load django_cfg %}
                                    <a href="{% lib_site_url %}" class="text-blue-600 hover:text-blue-700">
                                        {% lib_name %}
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Built-in Dashboard Tab Content -->
            <div x-show="activeTab === 'builtin'" style="display: block;">
                <div class="iframe-container">
                    <div class="iframe-loading" id="iframe-loading-builtin">
                        <div class="spinner"></div>
                        <p id="loading-text-builtin">Loading...</p>
                    </div>

                    <iframe
                        id="nextjs-dashboard-iframe-builtin"
                        class="nextjs-dashboard-iframe"
                        src="{% nextjs_admin_url %}"
                        data-original-src="{% nextjs_admin_url %}"
                        title="Next.js Dashboard"
                        sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals allow-storage-access-by-user-activation"
                    ></iframe>
                </div>
            </div>

            <!-- External Next.js Admin Tab Content -->
            {% if is_external_enabled %}
            <div x-show="activeTab === 'nextjs'" style="display: none;">
                <div class="iframe-container">
                    <div class="iframe-loading" id="iframe-loading-nextjs">
                        <div class="spinner"></div>
                        <p id="loading-text-nextjs">Loading...</p>
                    </div>

                    <iframe
                        id="nextjs-dashboard-iframe-nextjs"
                        class="nextjs-dashboard-iframe"
                        src="{% nextjs_external_admin_url %}"
                        data-original-src="{% nextjs_external_admin_url %}"
                        title="{% nextjs_external_admin_title %}"
                        sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals allow-storage-access-by-user-activation"
                    ></iframe>
                </div>
            </div>
            {% endif %}

            <!-- Docs Tab Content -->
            <div x-show="activeTab === 'docs'" style="display: none;">
                <div class="iframe-container">
                    <div class="iframe-loading" id="iframe-loading-docs">
                        <div class="spinner"></div>
                        <p id="loading-text-docs">Loading documentation...</p>
                    </div>

                    <iframe
                        id="nextjs-dashboard-iframe-docs"
                        class="nextjs-dashboard-iframe"
                        src="{% lib_docs_url %}"
                        data-original-src="{% lib_docs_url %}"
                        title="Documentation"
                        sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals allow-storage-access-by-user-activation"
                    ></iframe>
                </div>
            </div>
        </div>
    {% endcomponent %}
{% endblock %}

{% block footer %}
    {{ block.super }}
    <script>
        (function() {
            'use strict';

            /**
             * MessageBridge - Handles postMessage communication with internal Next.js iframes
             */
            class MessageBridge {
                constructor(iframe, origin) {
                    this.iframe = iframe;
                    this.origin = origin;
                    this.themeObserver = null;
                }

                /**
                 * Send theme data to iframe
                 */
                sendTheme() {
                    if (!this.iframe?.contentWindow) return;

                    const htmlElement = document.documentElement;
                    const isDark = htmlElement.classList.contains('dark');
                    const themeMode = this._getThemeMode();

                    try {
                        this.iframe.contentWindow.postMessage({
                            type: 'parent-theme',
                            data: {
                                theme: isDark ? 'dark' : 'light',
                                themeMode: themeMode
                            }
                        }, this.origin);
                    } catch (e) {
                        console.error('[Django-CFG] Failed to send theme:', e);
                    }
                }

                /**
                 * Send auth tokens to iframe
                 */
                sendAuth() {
                    if (!this.iframe?.contentWindow) return;

                    const authToken = localStorage.getItem('auth_token');
                    const refreshToken = localStorage.getItem('refresh_token');

                    if (!authToken) return;

                    try {
                        this.iframe.contentWindow.postMessage({
                            type: 'parent-auth',
                            data: { authToken, refreshToken }
                        }, this.origin);
                    } catch (e) {
                        console.error('[Django-CFG] Failed to send auth:', e);
                    }
                }

                /**
                 * Send all data (theme + auth)
                 */
                sendAllData() {
                    this.sendTheme();
                    this.sendAuth();
                }

                /**
                 * Start watching for theme changes
                 */
                watchThemeChanges() {
                    this.themeObserver = new MutationObserver(() => {
                        this.sendTheme();
                    });

                    this.themeObserver.observe(document.documentElement, {
                        attributes: true,
                        attributeFilter: ['class']
                    });
                }

                /**
                 * Stop watching
                 */
                destroy() {
                    if (this.themeObserver) {
                        this.themeObserver.disconnect();
                        this.themeObserver = null;
                    }
                }

                /**
                 * Get theme mode from Alpine.js
                 */
                _getThemeMode() {
                    if (!window.Alpine?.$$data) return 'auto';

                    try {
                        const alpineData = window.Alpine.$data(document.documentElement);
                        return alpineData?.adminTheme || 'auto';
                    } catch (e) {
                        return 'auto';
                    }
                }
            }

            /**
             * InternalIframeHandler - Handles Next.js internal iframes with postMessage
             */
            class InternalIframeHandler {
                constructor(iframe, loading, origin) {
                    this.iframe = iframe;
                    this.loading = loading;
                    this.origin = origin;
                    this.messageBridge = new MessageBridge(iframe, origin);
                    this.messageListener = null;
                }

                init() {
                    this._setupLoadHandler();
                    this._setupMessageListener();
                    this.messageBridge.watchThemeChanges();
                }

                _setupLoadHandler() {
                    this.iframe.addEventListener('load', () => {
                        setTimeout(() => {
                            this.messageBridge.sendAllData();
                        }, 100);
                    });
                }

                _setupMessageListener() {
                    this.messageListener = (event) => {
                        if (event.origin !== this.origin) return;

                        const { type, data } = event.data || {};
                        this._handleMessage(type, data);
                    };

                    window.addEventListener('message', this.messageListener);
                }

                _handleMessage(type, data) {
                    switch (type) {
                        case 'iframe-ready':
                            this.messageBridge.sendAllData();
                            break;

                        case 'iframe-auth-status':
                            console.log('[Django-CFG] Auth status:', data);
                            break;

                        case 'iframe-resize':
                            this._handleResize();
                            break;

                        case 'iframe-navigation':
                            this._handleNavigation(data?.path);
                            break;
                    }
                }

                _handleResize() {
                    if (this.iframe.classList.contains('loaded')) return;

                    console.log('[Django-CFG] First resize - showing iframe');
                    this.loading?.classList.add('hidden');
                    this.iframe.classList.add('loaded');
                }

                _handleNavigation(path) {
                    if (!path) return;

                    console.log('[Django-CFG] Navigation:', path);

                    // Track path for "Open in New Window" (only for nextjs tab)
                    if (this.iframe.id === 'nextjs-dashboard-iframe-nextjs') {
                        this._updateAlpinePath(path);
                    }
                }

                _updateAlpinePath(path) {
                    const alpineEl = document.querySelector('[x-data]');
                    if (!alpineEl || !window.Alpine) return;

                    const alpineData = window.Alpine.$data(alpineEl);
                    if (alpineData) {
                        alpineData.currentNextjsPath = path;
                    }
                }

                destroy() {
                    this.messageBridge.destroy();
                    if (this.messageListener) {
                        window.removeEventListener('message', this.messageListener);
                    }
                }
            }

            /**
             * ExternalIframeHandler - Handles external iframes (docs) without postMessage
             */
            class ExternalIframeHandler {
                constructor(iframe, loading) {
                    this.iframe = iframe;
                    this.loading = loading;
                    this.LOAD_TIMEOUT = 5000;
                }

                init() {
                    this._setupLoadHandler();
                    this._setupErrorHandler();
                    this._setupTimeout();
                }

                _setupLoadHandler() {
                    this.iframe.addEventListener('load', () => {
                        console.log('[Django-CFG] External iframe loaded');
                        this._showIframe();
                    });
                }

                _setupErrorHandler() {
                    this.iframe.addEventListener('error', () => {
                        console.error('[Django-CFG] External iframe failed to load');
                        this._showError();
                    });
                }

                _setupTimeout() {
                    setTimeout(() => {
                        if (!this.iframe.classList.contains('loaded')) {
                            console.log('[Django-CFG] Timeout - showing iframe anyway');
                            this._showIframe();
                        }
                    }, this.LOAD_TIMEOUT);
                }

                _showIframe() {
                    this.loading?.classList.add('hidden');
                    this.iframe.classList.add('loaded');
                }

                _showError() {
                    const loadingText = this.loading?.querySelector('p');
                    if (loadingText) {
                        loadingText.textContent = 'Failed to load. Please check your connection.';
                    }
                }

                destroy() {
                    // No cleanup needed for external iframes
                }
            }

            /**
             * IframeManager - Factory for creating appropriate iframe handlers
             */
            class IframeManager {
                constructor() {
                    this.handlers = [];
                }

                /**
                 * Register an iframe for management
                 */
                register(iframeId, loadingId, options = {}) {
                    const iframe = document.getElementById(iframeId);
                    const loading = document.getElementById(loadingId);

                    if (!iframe) {
                        console.warn(`[Django-CFG] Iframe not found: ${iframeId}`);
                        return;
                    }

                    const handler = this._createHandler(iframe, loading, options);
                    if (handler) {
                        handler.init();
                        this.handlers.push(handler);
                    }
                }

                /**
                 * Create appropriate handler based on iframe type
                 */
                _createHandler(iframe, loading, options) {
                    const src = iframe.src || iframe.getAttribute('src');
                    if (!src) {
                        console.warn('[Django-CFG] Iframe has no src');
                        return null;
                    }

                    const url = new URL(src, window.location.origin);
                    const isExternal = options.external || url.origin !== window.location.origin;

                    if (isExternal) {
                        return new ExternalIframeHandler(iframe, loading);
                    } else {
                        return new InternalIframeHandler(iframe, loading, url.origin);
                    }
                }

                /**
                 * Cleanup all handlers
                 */
                destroy() {
                    this.handlers.forEach(handler => handler.destroy());
                    this.handlers = [];
                }
            }

            // Initialize iframe manager
            const manager = new IframeManager();

            // Register all iframes
            manager.register('nextjs-dashboard-iframe-builtin', 'iframe-loading-builtin');
            manager.register('nextjs-dashboard-iframe-nextjs', 'iframe-loading-nextjs');
            manager.register('nextjs-dashboard-iframe-docs', 'iframe-loading-docs', { external: true });

            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                manager.destroy();
            });

        })();
    </script>
{% endblock %}
