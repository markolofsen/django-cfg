{% load unfold %}

<!-- Commands Section -->
<div class="space-y-8" x-data="commandsSection({{ data.commands|length }})">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-font-important-light dark:text-font-important-dark">{{ title|default:"Management Commands" }}</h1>
            <p class="text-font-default-light dark:text-font-default-dark mt-2">
                Execute Django management commands directly from the dashboard
            </p>
        </div>
        <div class="text-sm text-font-subtle-light dark:text-font-subtle-dark">
            Total: <span x-text="visibleCommands" class="font-mono font-semibold text-font-important-light dark:text-font-important-dark"></span> commands
        </div>
    </div>

    <!-- Search Box -->
    <div class="flex items-center gap-3 mb-6">
        <div class="relative flex-1 max-w-md">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-base-400 dark:text-base-500">search</span>
            <input
                type="text"
                x-model="searchQuery"
                @input="search()"
                placeholder="Search commands..."
                class="w-full pl-10 pr-10 py-2 border border-base-200 dark:border-base-700 rounded-default bg-white dark:bg-base-800 text-font-important-light dark:text-font-important-dark placeholder-font-subtle-light dark:placeholder-font-subtle-dark focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            />
            <button
                x-show="showClearButton"
                @click="clearSearch()"
                class="absolute right-3 top-1/2 -translate-y-1/2 text-base-400 dark:text-base-500 hover:text-base-600 dark:hover:text-base-300"
            >
                <span class="material-symbols-outlined text-lg">close</span>
            </button>
        </div>
    </div>

    <!-- Commands by Category -->
    {% if data.categories %}
        <div class="flex flex-col gap-6">
            {% for category, category_commands in data.categories.items %}
                {% if category_commands %}
                    <div class="category-block bg-gradient-to-br from-white to-base-50 dark:from-base-800 dark:to-base-900 rounded-default shadow-md border border-base-200 dark:border-base-700 overflow-hidden">
                        <div class="p-6 border-b border-base-200 dark:border-base-700 category-toggle cursor-pointer hover:bg-base-100/50 dark:hover:bg-base-900/30 transition-all duration-200"
                             @click="toggleCategory('{{ category }}')"
                             data-category="{{ category }}">
                            <div class="w-full flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-font-important-light dark:text-font-important-dark flex items-center">
                                    <div class="w-10 h-10 rounded-lg bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center mr-3">
                                        <span class="material-symbols-outlined text-primary-600 dark:text-primary-400">
                                            {% if category == 'django_cfg' %}settings
                                            {% elif category == 'django_core' %}apps
                                            {% elif category == 'third_party' %}extension
                                            {% else %}folder{% endif %}
                                        </span>
                                    </div>
                                    <div>
                                        <div class="flex items-center gap-2">
                                            {{ category|title }} Commands
                                            <span class="px-2 py-0.5 text-xs font-medium rounded-full bg-base-200 dark:bg-base-700 text-font-default-light dark:text-font-default-dark category-count">
                                                {{ category_commands|length }}
                                            </span>
                                        </div>
                                    </div>
                                </h3>
                                <span
                                    class="material-symbols-outlined text-base-400 dark:text-base-500 transition-transform duration-200 select-none"
                                    x-text="isCategoryExpanded('{{ category }}') ? 'expand_less' : 'expand_more'"
                                ></span>
                            </div>
                        </div>
                        <div class="p-6 category-content bg-base-50/30 dark:bg-base-900/30"
                             data-category="{{ category }}"
                             x-show="isCategoryExpanded('{{ category }}')"
                             x-cloak>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {% for cmd in category_commands %}
                                    <button type="button"
                                            @click="confirmCommand('{{ cmd.name }}', '{{ cmd.app }}', '{{ cmd.description|escapejs|default:'-' }}')"
                                            class="command-btn command-item text-left p-4 rounded-default border border-base-200/60 dark:border-base-700/60 bg-white dark:bg-base-800 hover:border-base-300 dark:hover:border-base-600 hover:bg-white/80 dark:hover:bg-base-800/80 transition-all duration-200 group"
                                            data-command="{{ cmd.name }}"
                                            data-app="{{ cmd.app }}"
                                            data-description="{{ cmd.description|escapejs|default:'-' }}">
                                        <div class="flex items-center gap-3">
                                            <div class="flex-shrink-0">
                                                <span class="material-symbols-outlined text-primary-500 dark:text-primary-400 text-xl group-hover:text-primary-600 dark:group-hover:text-primary-300 transition-colors">terminal</span>
                                            </div>
                                            <div class="flex-1 grow min-w-0">
                                                <p class="font-mono text-sm text-font-important-light dark:text-font-important-dark font-semibold command-name truncate">{{ cmd.name }}</p>
                                                {% if cmd.description %}
                                                    <p class="text-xs text-font-default-light dark:text-font-default-dark mt-1 line-clamp-2">{{ cmd.description }}</p>
                                                {% endif %}
                                                {% if cmd.app %}
                                                    <p class="text-xs text-font-subtle-light dark:text-font-subtle-dark mt-1 truncate">
                                                        <span class="opacity-60">from</span> {{ cmd.app }}
                                                    </p>
                                                {% endif %}
                                            </div>
                                            <div class="flex-shrink-0">
                                                <span class="material-symbols-outlined text-base-400 dark:text-base-600 group-hover:text-primary-500 dark:group-hover:text-primary-400 transition-colors text-2xl">chevron_right</span>
                                            </div>
                                        </div>
                                    </button>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    {% else %}
        <!-- Fallback: All Commands List -->
        <div class="bg-white dark:bg-base-800 rounded-default shadow-sm border border-base-200 dark:border-base-700">
            <div class="p-6 border-b border-base-200 dark:border-base-700">
                <h3 class="text-lg font-semibold text-font-important-light dark:text-font-important-dark flex items-center">
                    <span class="material-symbols-outlined text-primary-500 mr-2">list</span>
                    All Commands
                </h3>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for cmd in data.commands %}
                        <button type="button"
                                class="command-btn text-left p-4 rounded-default border border-base-200 dark:border-base-700 bg-white dark:bg-base-800 hover:bg-base-100 dark:hover:bg-white/[.04] transition-colors"
                                data-command="{{ cmd.name }}">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-mono text-sm text-font-important-light dark:text-font-important-dark font-semibold">{{ cmd.name }}</p>
                                    {% if cmd.app %}
                                        <p class="text-xs text-font-subtle-light dark:text-font-subtle-dark mt-1">{{ cmd.app }}</p>
                                    {% endif %}
                                </div>
                                <span class="material-symbols-outlined text-primary-500">play_arrow</span>
                            </div>
                        </button>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Confirm Modal -->
    <div x-show="showConfirmModal"
         @click.self="showConfirmModal = false"
         x-cloak
         x-data="{ modalTab: 'confirm' }"
         class="backdrop-blur-xs bg-base-900/80 fixed inset-0 p-4 lg:p-32 z-[1000]">
        <div class="bg-white dark:bg-base-800 rounded-default shadow-lg border border-base-200 dark:border-base-700 max-w-3xl mx-auto w-full max-h-[80vh] flex flex-col">
            <div class="px-4 py-3 border-b border-base-200 dark:border-base-700">
                <h3 class="text-lg font-semibold text-font-important-light dark:text-font-important-dark flex items-center gap-2">
                    <span class="material-symbols-outlined text-amber-500 dark:text-amber-400">warning</span>
                    Confirm Command Execution
                </h3>

                <!-- Tabs -->
                <div class="flex gap-2 mt-4 border-b border-base-200 dark:border-base-700">
                    <button type="button"
                            @click="modalTab = 'confirm'"
                            :class="modalTab === 'confirm' ? 'border-b-2 border-primary-600 text-primary-600' : 'text-font-subtle-light dark:text-font-subtle-dark'"
                            class="px-4 py-2 font-medium transition-colors">
                        Confirm
                    </button>
                    <button type="button"
                            @click="modalTab = 'help'"
                            :class="modalTab === 'help' ? 'border-b-2 border-primary-600 text-primary-600' : 'text-font-subtle-light dark:text-font-subtle-dark'"
                            class="px-4 py-2 font-medium transition-colors flex items-center gap-1">
                        <span class="material-icons text-sm">help_outline</span>
                        Help
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto">
                <!-- Confirm Tab -->
                <div x-show="modalTab === 'confirm'" class="p-6">
                    <p class="text-font-default-light dark:text-font-default-dark mb-4">
                        Are you sure you want to execute the following command?
                    </p>
                    <div class="bg-base-100 dark:bg-base-900 rounded-default p-4 border border-base-200 dark:border-base-700">
                        <div class="flex items-start gap-3">
                            <span class="material-symbols-outlined text-primary-600 dark:text-primary-400 text-xl">terminal</span>
                            <div class="flex-1 min-w-0">
                                <p class="font-mono text-sm font-semibold text-font-important-light dark:text-font-important-dark" x-text="currentCommand"></p>
                                <p class="text-xs text-font-subtle-light dark:text-font-subtle-dark mt-2" x-show="currentCommandApp" x-text="'from ' + currentCommandApp"></p>
                                <p class="text-xs text-font-default-light dark:text-font-default-dark mt-1" x-show="currentCommandDescription" x-text="currentCommandDescription"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Help Tab -->
                <div x-show="modalTab === 'help'" class="p-6">
                    <div class="mb-4">
                        <h4 class="text-lg font-semibold text-font-important-light dark:text-font-important-dark mb-2">Command Help</h4>
                        <p class="text-sm text-font-subtle-light dark:text-font-subtle-dark mb-4">
                            Get detailed information about this command
                        </p>
                    </div>

                    <div class="bg-base-100 dark:bg-base-900 rounded-default p-4 border border-base-200 dark:border-base-700 mb-4">
                        <div class="flex items-start gap-3">
                            <span class="material-icons text-primary-600 dark:text-primary-400">info</span>
                            <div class="flex-1">
                                <p class="font-semibold text-font-important-light dark:text-font-important-dark mb-2">Description</p>
                                <p class="text-sm text-font-default-light dark:text-font-default-dark" x-text="currentCommandDescription || 'No description available'"></p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-base-100 dark:bg-base-900 rounded-default p-4 border border-base-200 dark:border-base-700">
                        <div class="flex items-start gap-3">
                            <span class="material-icons text-blue-600 dark:text-blue-400">terminal</span>
                            <div class="flex-1">
                                <p class="font-semibold text-font-important-light dark:text-font-important-dark mb-2">Usage</p>
                                <div class="bg-base-900 dark:bg-black text-green-400 p-3 rounded-default font-mono text-xs">
                                    <span>python manage.py <span x-text="currentCommand"></span> [options]</span>
                                </div>
                                <p class="text-xs text-font-subtle-light dark:text-font-subtle-dark mt-2">
                                    For detailed help, run: <code class="bg-base-200 dark:bg-base-700 px-2 py-1 rounded">python manage.py help <span x-text="currentCommand"></span></code>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-4 py-3 border-t border-base-200 dark:border-base-800 flex items-center justify-end gap-3">
                <button type="button" @click="cancelExecution()" class="px-4 py-2 text-font-default-light dark:text-font-default-dark hover:bg-base-100 dark:hover:bg-base-700 rounded-default transition-colors">
                    Cancel
                </button>
                <button type="button" @click="executeCommand()" class="px-4 py-2 bg-primary-600 text-white rounded-default hover:bg-primary-700 transition-colors font-medium">
                    Execute Command
                </button>
            </div>
        </div>
    </div>

    <!-- Command Output Modal -->
    <div x-show="showOutputModal"
         @click.self="closeOutputModal()"
         x-cloak
         class="backdrop-blur-xs bg-base-900/80 flex flex-col fixed inset-0 p-4 lg:p-32 z-[1000]">
        <div class="bg-white dark:bg-base-800 flex flex-col max-w-3xl min-h-0 mx-auto overflow-hidden rounded-default shadow-lg w-full">
            <div class="flex items-center justify-between px-4 py-3 border-b border-base-200 dark:border-base-700">
                <h3 class="text-lg font-semibold text-font-important-light dark:text-font-important-dark flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary-600 dark:text-primary-400">terminal</span>
                    <span class="font-mono" x-text="currentCommand"></span>
                </h3>
                <button type="button" @click="closeOutputModal()" class="text-base-400 dark:text-base-500 hover:text-base-600 dark:hover:text-base-300 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="grow overflow-y-auto overflow-x-hidden w-full" x-ref="commandOutput">
                <div class="p-4">
                    <pre x-text="commandOutput" class="bg-base-900 dark:bg-black text-green-400 p-4 rounded-default font-mono text-xs leading-relaxed whitespace-pre overflow-x-auto"></pre>
                </div>
            </div>
            <div class="px-4 py-3 border-t border-base-200 dark:border-base-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div :class="statusClass" class="w-3 h-3 rounded-full"></div>
                        <span class="text-sm font-medium" x-text="statusText"></span>
                    </div>
                    <button type="button" @click="copyOutput()" class="px-4 py-2 bg-primary-600 text-white rounded-default hover:bg-primary-700 transition-colors flex items-center gap-2 font-medium">
                        <span class="material-symbols-outlined text-base">content_copy</span>
                        Copy Output
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Alpine component -->
    {% load static %}
    <script src="{% static 'admin/js/alpine/commands-section.js' %}"></script>

    <!-- Documentation Section (Collapsible) -->
    <div class="mt-12" x-data="{ docsExpanded: false }">
        <div class="bg-gradient-to-br from-white to-base-50 dark:from-base-800 dark:to-base-900 rounded-lg shadow-md border border-base-200 dark:border-base-700 overflow-hidden">
            <!-- Header (Clickable) -->
            <div class="p-6 cursor-pointer hover:bg-base-100/50 dark:hover:bg-base-900/30 transition-all duration-200"
                 @click="docsExpanded = !docsExpanded">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center mr-3">
                            <span class="material-icons text-blue-600 dark:text-blue-400">menu_book</span>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-font-important-light dark:text-font-important-dark">
                                Commands Documentation
                            </h2>
                            <p class="text-sm text-font-subtle-light dark:text-font-subtle-dark mt-1">
                                Complete guide to Django management commands
                            </p>
                        </div>
                    </div>
                    <span class="material-icons text-base-400 dark:text-base-500 transition-transform duration-200"
                          x-text="docsExpanded ? 'expand_less' : 'expand_more'"></span>
                </div>
            </div>

            <!-- Content (Collapsible) -->
            <div class="border-t border-base-200 dark:border-base-700"
                 x-show="docsExpanded"
                 x-collapse>
                <div class="p-6 bg-base-50/30 dark:bg-base-900/30">
                    {% if documentation_content %}
                        <!-- Rendered Markdown Content with Collapsible Sections -->
                        <div class="documentation-content" x-data="documentationCollapse()">
                            {{ documentation_content|safe }}
                        </div>
                    {% else %}
                        <!-- Fallback: Basic documentation -->
                        <div class="documentation-content">
                            <h2>Django Management Commands</h2>
                            <p>Django management commands provide a command-line interface for administrative tasks.</p>

                            <h3>Common Commands</h3>
                            <ul>
                                <li><code>migrate</code> - Apply database migrations</li>
                                <li><code>makemigrations</code> - Create new migrations</li>
                                <li><code>runserver</code> - Start development server</li>
                                <li><code>createsuperuser</code> - Create admin user</li>
                                <li><code>collectstatic</code> - Collect static files</li>
                            </ul>

                            <h3>Getting Help</h3>
                            <p>To get help for any command, use:</p>
                            <pre><code>python manage.py help &lt;command_name&gt;</code></pre>

                            <h3>Custom Commands</h3>
                            <p>You can create custom management commands by adding them to <code>management/commands/</code> directory in your Django app.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Documentation Collapse Script -->
    <script>
        function documentationCollapse() {
            return {
                sections: {},
                init() {
                    // Find all h2 elements and make them collapsible
                    this.$nextTick(() => {
                        const h2Elements = this.$el.querySelectorAll('h2');
                        h2Elements.forEach((h2, index) => {
                            const sectionId = `section-${index}`;
                            this.sections[sectionId] = false; // collapsed by default

                            // Wrap h2 in clickable div
                            const wrapper = document.createElement('div');
                            wrapper.className = 'doc-section-header';
                            wrapper.setAttribute('x-on:click', `sections['${sectionId}'] = !sections['${sectionId}']`);

                            const icon = document.createElement('span');
                            icon.className = 'material-icons doc-section-icon';
                            icon.setAttribute('x-text', `sections['${sectionId}'] ? 'expand_less' : 'expand_more'`);

                            h2.parentNode.insertBefore(wrapper, h2);
                            wrapper.appendChild(icon);
                            wrapper.appendChild(h2);

                            // Wrap content until next h2
                            const contentWrapper = document.createElement('div');
                            contentWrapper.className = 'doc-section-content';
                            contentWrapper.setAttribute('x-show', `sections['${sectionId}']`);
                            contentWrapper.setAttribute('x-collapse', '');

                            let nextElement = wrapper.nextElementSibling;
                            const elementsToMove = [];

                            while (nextElement && nextElement.tagName !== 'H2') {
                                elementsToMove.push(nextElement);
                                nextElement = nextElement.nextElementSibling;
                            }

                            wrapper.parentNode.insertBefore(contentWrapper, wrapper.nextElementSibling);
                            elementsToMove.forEach(el => contentWrapper.appendChild(el));
                        });
                    });
                }
            };
        }
    </script>

    <!-- Documentation Styles -->
    <style>
        .documentation-content {
            color: #374151;
            line-height: 1.75;
        }
        html.dark .documentation-content {
            color: #d1d5db;
        }
        .documentation-content h1 {
            font-size: 2em;
            font-weight: 700;
            margin-top: 1.5em;
            margin-bottom: 0.75em;
            color: #111827;
        }
        html.dark .documentation-content h1 {
            color: #f9fafb;
        }
        .doc-section-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.75em 0;
            margin-top: 1.25em;
            border-bottom: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        .doc-section-header:hover {
            background-color: rgba(0, 0, 0, 0.02);
            padding-left: 0.5em;
            margin-left: -0.5em;
            padding-right: 0.5em;
            margin-right: -0.5em;
            border-radius: 0.5em;
        }
        html.dark .doc-section-header {
            border-bottom-color: #374151;
        }
        html.dark .doc-section-header:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        .doc-section-icon {
            color: #6b7280;
            font-size: 1.25em;
            margin-right: 0.5em;
            transition: transform 0.2s ease;
        }
        html.dark .doc-section-icon {
            color: #9ca3af;
        }
        .doc-section-header h2 {
            font-size: 1.5em;
            font-weight: 600;
            margin: 0;
            color: #1f2937;
            border: none;
            padding: 0;
        }
        html.dark .doc-section-header h2 {
            color: #e5e7eb;
        }
        .doc-section-content {
            padding-left: 2.25em;
            margin-bottom: 1em;
        }
        .documentation-content h3 {
            font-size: 1.25em;
            font-weight: 600;
            margin-top: 1em;
            margin-bottom: 0.5em;
            color: #374151;
        }
        html.dark .documentation-content h3 {
            color: #d1d5db;
        }
        .documentation-content h4 {
            font-size: 1.1em;
            font-weight: 600;
            margin-top: 0.875em;
            margin-bottom: 0.5em;
            color: #4b5563;
        }
        html.dark .documentation-content h4 {
            color: #9ca3af;
        }
        .documentation-content p {
            margin-bottom: 1em;
        }
        .documentation-content ul, .documentation-content ol {
            margin-bottom: 1em;
            padding-left: 1.5em;
        }
        .documentation-content li {
            margin-bottom: 0.5em;
        }
        .documentation-content code {
            background-color: #f3f4f6;
            color: #dc2626;
            padding: 0.125em 0.375em;
            border-radius: 0.25em;
            font-family: 'Courier New', monospace;
            font-size: 0.875em;
        }
        html.dark .documentation-content code {
            background-color: #1f2937;
            color: #f87171;
        }
        .documentation-content pre {
            background-color: #1f2937;
            color: #e5e7eb;
            padding: 1em;
            border-radius: 0.5em;
            overflow-x: auto;
            margin-bottom: 1em;
        }
        html.dark .documentation-content pre {
            background-color: #111827;
        }
        .documentation-content pre code {
            background-color: transparent;
            color: #10b981;
            padding: 0;
        }
        .documentation-content a {
            color: #2563eb;
            text-decoration: underline;
        }
        html.dark .documentation-content a {
            color: #60a5fa;
        }
        .documentation-content strong {
            font-weight: 600;
            color: #111827;
        }
        html.dark .documentation-content strong {
            color: #f9fafb;
        }
        .documentation-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
        }
        .documentation-content th, .documentation-content td {
            border: 1px solid #e5e7eb;
            padding: 0.5em;
            text-align: left;
        }
        html.dark .documentation-content th, html.dark .documentation-content td {
            border-color: #374151;
        }
        .documentation-content th {
            background-color: #f3f4f6;
            font-weight: 600;
        }
        html.dark .documentation-content th {
            background-color: #1f2937;
        }
    </style>
</div>

