# API Services Architecture

Project API services for Unrealon Cloud application.

## Overview

This directory contains **two types of API services**:

1. **CUSTOM API Services** (Workspace, Git, AI Agents, etc.) - Project-specific, use local BaseClient
2. **CFG API Services** (Accounts, Payments, Leads, etc.) - Universal Django-CFG services, use `@djangocfg/api` package

---

## Directory Structure

```
src/api/
├── README.md                    # This file
├── generated/
│   └── custom/                  # Auto-generated CUSTOM API clients
│       ├── index.ts             # API class with workspaces, git, aiAgents, etc.
│       ├── workspaces/          # Workspace endpoints
│       ├── git/                 # Git endpoints
│       ├── ai_agents/           # AI Agents endpoints
│       ├── notifications/       # Notifications endpoints
│       ├── collaboration/       # Collaboration endpoints
│       ├── templates/           # Templates endpoints
│       ├── integrations/        # Integrations endpoints
│       ├── monitoring/          # Monitoring endpoints
│       └── quotas/              # Quotas endpoints
└── services/
    ├── BaseClient.ts            # BaseClient for CUSTOM API (local)
    ├── index.ts                 # Service exports
    ├── WorkspaceService.ts      # CUSTOM: Workspace management
    ├── GitService.ts            # CUSTOM: Git operations
    ├── AiAgentsService.ts       # CUSTOM: AI agent management
    ├── SessionService.ts        # CUSTOM: Session management
    ├── NotificationsService.ts  # CUSTOM: Notifications
    └── ...                      # Other CUSTOM services
```

---

## Two Types of API Services

### 1. CUSTOM API Services (Project-Specific)

**Location:** `src/api/services/` (this directory)
**BaseClient:** Local `./BaseClient.ts`
**API Class:** `../generated/custom/index.ts`
**Types:** `../generated/custom` namespaces

**Examples:** WorkspaceService, GitService, AiAgentsService, SessionService

**Key Characteristics:**
- ✅ Import BaseClient from `./BaseClient`
- ✅ Import types from `../generated/custom`
- ✅ Use `this.api.workspaces.*`, `this.api.git.*`, `this.api.aiAgents.*`, etc.
- ✅ Generated from project-specific OpenAPI schema

### 2. CFG API Services (Universal Django-CFG)

**Location:** `@djangocfg/api` package
**BaseClient:** `@djangocfg/api` package export
**API Class:** `@djangocfg/api/generated_cfg/index.ts`
**Types:** `@djangocfg/api` type namespaces

**Examples:** AccountsService, PaymentsService, LeadsService, NewsletterService

**Key Characteristics:**
- ✅ Import BaseClient from `@djangocfg/api`
- ✅ Import types from `@djangocfg/api`
- ✅ Use `this.api.cfgAccounts.*`, `this.api.cfgPayments.*`, etc.
- ✅ Shared across all Unrealon applications

---

## Creating CUSTOM Services (Project-Specific)

### Step 1: Verify Generated Clients

CUSTOM API clients are auto-generated by Django management command:

```bash
# Backend (Django)
python manage.py generate_api

# This creates:
# - projects/django/typescript/custom/   → Source
# - apps/cloud/src/api/generated/custom/ → Copied to frontend
```

### Step 2: Create Service File

```bash
touch src/api/services/MyCustomService.ts
```

### Step 3: Implement Service

```typescript
/**
 * My Custom Service
 *
 * Service for my custom feature
 * Uses this.api.myCustom.* for authenticated calls (CRITICAL!)
 */

import { BaseClient } from './BaseClient';
import type { MyCustomTypes } from '../generated/custom';

// ===============================
// Type Aliases
// ===============================
type MyResource = MyCustomTypes.MyResourceReadable;
type MyResourceCreate = MyCustomTypes.MyResourceCreate;
type MyResourceUpdate = MyCustomTypes.MyResourceUpdate;

// ===============================
// Type Re-exports
// ===============================
export type { MyResource, MyResourceCreate, MyResourceUpdate };

/**
 * My Custom Service
 */
export class MyCustomService extends BaseClient {
  /**
   * List resources (paginated)
   */
  static async list(params?: { page?: number; page_size?: number }) {
    try {
      return await this.api.myCustom.myCustomMyResourcesList({ query: params });
    } catch (error) {
      return this.handleError(error, 'MyCustomService.list');
    }
  }

  /**
   * Get resource by ID
   */
  static async get(id: string) {
    try {
      return await this.api.myCustom.myCustomMyResourcesRetrieve({ path: { id } });
    } catch (error) {
      return this.handleError(error, 'MyCustomService.get');
    }
  }

  /**
   * Create resource
   */
  static async create(data: MyResourceCreate) {
    try {
      return await this.api.myCustom.myCustomMyResourcesCreate({ body: data });
    } catch (error) {
      return this.handleError(error, 'MyCustomService.create');
    }
  }
}
```

### Step 4: Export from Index

Add to `services/index.ts`:

```typescript
export { MyCustomService } from './MyCustomService';
export type { MyResource, MyResourceCreate } from './MyCustomService';
```

---

## Creating CFG Services (Universal)

**⚠️ IMPORTANT:** CFG services should be created in `@djangocfg/api` package, not here!

If you need a CFG service (Accounts, Payments, etc.), add it to:
```
packages/api/src/services/cfg/
```

Then import it in your app:
```typescript
import { AccountsService } from '@djangocfg/api';
```

---

## Critical Import Patterns

### ✅ CORRECT: CUSTOM Service

```typescript
// WorkspaceService.ts
import { BaseClient } from './BaseClient';                    // ✅ Local BaseClient
import type { WorkspacesTypes } from '../generated/custom';  // ✅ CUSTOM types

export class WorkspaceService extends BaseClient {
  static async list() {
    try {
      return await this.api.workspaces.workspacesWorkspacesList();  // ✅ Uses CUSTOM API
    } catch (error) {
      return this.handleError(error, 'WorkspaceService.list');
    }
  }
}
```

### ❌ WRONG: CUSTOM Service with CFG imports

```typescript
// WorkspaceService.ts
import { BaseClient } from '@djangocfg/api';              // ❌ WRONG! CFG BaseClient
import type { WorkspacesTypes } from '@djangocfg/api';   // ❌ WRONG! CFG types

export class WorkspaceService extends BaseClient {
  static async list() {
    try {
      return await this.api.workspaces.workspacesWorkspacesList();  // ❌ this.api.workspaces is undefined!
    } catch (error) {
      return this.handleError(error, 'WorkspaceService.list');
    }
  }
}
```

**Why it's wrong:**
- `@djangocfg/api` BaseClient uses CFG API class (cfgAccounts, cfgPayments, etc.)
- CUSTOM endpoints (workspaces, git, etc.) are NOT available in CFG API
- `this.api.workspaces` will be `undefined` → TypeError!

---

## Available CUSTOM API Endpoints

The local API class (`../generated/custom/index.ts`) provides:

```typescript
api.workspaces.*      // Workspace management
api.git.*             // Git operations (repos, branches, commits)
api.aiAgents.*        // AI agents, models, providers, tasks
api.notifications.*   // Real-time notifications
api.collaboration.*   // Multi-user collaboration (stub)
api.templates.*       // Project templates (stub)
api.integrations.*    // External integrations (stub)
api.monitoring.*      // System monitoring (stub)
api.quotas.*          // Workspace quotas (stub)
```

**Note:** "stub" endpoints have minimal/no backend implementation yet.

---

## Available CFG API Endpoints

The `@djangocfg/api` package provides:

```typescript
api.cfgAccounts.*     // User accounts, profiles, authentication
api.cfgPayments.*     // Payment processing
api.cfgLeads.*        // Lead submissions
api.cfgNewsletter.*   // Newsletter subscriptions
api.cfgSupport.*      // Support tickets
api.cfgAgents.*       // AI agents (CFG version)
api.cfgTasks.*        // Tasks management
```

---

## Component Usage

### Using CUSTOM Service

```typescript
import { WorkspaceService, type Workspace } from '@/api/services';

const WorkspacesPage = () => {
  const [workspaces, setWorkspaces] = useState<Workspace[]>([]);

  useEffect(() => {
    const loadWorkspaces = async () => {
      const result = await WorkspaceService.list();

      if (result.error) {
        console.error('Error:', result.error.message);
      } else if (result.data?.results) {
        setWorkspaces(result.data.results);
      }
    };

    loadWorkspaces();
  }, []);

  return (
    <ul>
      {workspaces.map(workspace => (
        <li key={workspace.id}>{workspace.name}</li>
      ))}
    </ul>
  );
};
```

### Using CFG Service

```typescript
import { AccountsService } from '@djangocfg/api';

const ProfilePage = () => {
  const [profile, setProfile] = useState(null);

  useEffect(() => {
    const loadProfile = async () => {
      const result = await AccountsService.getProfile();

      if (result.error) {
        console.error('Error:', result.error.message);
      } else if (result.data) {
        setProfile(result.data);
      }
    };

    loadProfile();
  }, []);

  return <div>{profile?.username}</div>;
};
```

---

## Error Handling

Both CUSTOM and CFG services return the same error format:

```typescript
const result = await WorkspaceService.create(data);

if (result.error) {
  // Error occurred
  const { message, statusCode, fieldErrors, generalErrors } = result.error;

  // Handle specific status codes
  if (statusCode === 401) {
    router.push('/auth');
  } else if (statusCode === 422) {
    // Validation errors
    Object.entries(fieldErrors).forEach(([field, messages]) => {
      setError(field, { message: messages[0] });
    });
  } else {
    toast.error(message);
  }
} else if (result.data) {
  // Success
  toast.success('Workspace created!');
}
```

---

## Authentication

### CUSTOM API Authentication

CUSTOM services use local API instance:

```typescript
import { api } from './BaseClient';

// Set token
api.setToken(accessToken, refreshToken);

// Check authentication
if (api.isAuthenticated()) {
  // Make authenticated requests
}

// Clear tokens (logout)
api.clearTokens();
```

### CFG API Authentication

CFG services use package API instance:

```typescript
import { api } from '@djangocfg/api';

// Same methods as CUSTOM API
api.setToken(accessToken, refreshToken);
api.isAuthenticated();
api.clearTokens();
```

---

## Best Practices

### ✅ DO:

1. **Use correct BaseClient:**
   - CUSTOM services → `import { BaseClient } from './BaseClient'`
   - CFG services → `import { BaseClient } from '@djangocfg/api'`

2. **Use correct types:**
   - CUSTOM types → `import type { WorkspacesTypes } from '../generated/custom'`
   - CFG types → `import type { Cfg_accountsTypes } from '@djangocfg/api'`

3. **Use this.api.* for ALL API calls** (never import SDK methods directly)

4. **Pass context to handleError()** (e.g., `'WorkspaceService.list'`)

5. **Re-export types** for component usage

6. **Add JSDoc comments** to all methods

### ❌ DON'T:

1. **Never mix BaseClient imports:**
   - ❌ CUSTOM service with `@djangocfg/api` BaseClient
   - ❌ CFG service with local `./BaseClient`

2. **Never import SDK methods directly** (bypasses authentication!)

3. **Never create local type definitions** (use generated types)

4. **Never throw in handleError** (return ServiceErrorResponse)

5. **Never create CFG services here** (use `@djangocfg/api` package)

---

## Debugging Common Issues

### Issue: `this.api.workspaces` is undefined

**Cause:** Using wrong BaseClient in CUSTOM service

**Solution:**
```typescript
// ❌ WRONG
import { BaseClient } from '@djangocfg/api';

// ✅ CORRECT
import { BaseClient } from './BaseClient';
```

### Issue: Type not found in `@djangocfg/api`

**Cause:** Trying to import CUSTOM types from CFG package

**Solution:**
```typescript
// ❌ WRONG
import type { WorkspacesTypes } from '@djangocfg/api';

// ✅ CORRECT
import type { WorkspacesTypes } from '../generated/custom';
```

### Issue: `this.api.cfgAccounts` is undefined

**Cause:** Using local BaseClient for CFG service

**Solution:** Move service to `@djangocfg/api` package or use correct BaseClient

---

## Service Examples

### Example 1: WorkspaceService (CUSTOM)

```typescript
import { BaseClient } from './BaseClient';
import type { WorkspacesTypes } from '../generated/custom';

type Workspace = WorkspacesTypes.WorkspaceReadable;

export class WorkspaceService extends BaseClient {
  static async list() {
    try {
      return await this.api.workspaces.workspacesWorkspacesList();
    } catch (error) {
      return this.handleError(error, 'WorkspaceService.list');
    }
  }
}
```

### Example 2: AccountsService (CFG) - From Package

```typescript
// In @djangocfg/api package
import { BaseClient } from '../BaseClient';  // Package BaseClient
import type { Cfg_accountsTypes } from '../generated_cfg';

export class AccountsService extends BaseClient {
  static async getProfile() {
    try {
      return await this.api.cfgAccounts.accountsProfileRetrieve();
    } catch (error) {
      return this.handleError(error, 'AccountsService.getProfile');
    }
  }
}
```

---

## Regenerating API Clients

When backend API changes, regenerate CUSTOM clients:

```bash
# Backend (Django)
cd projects/django
python manage.py generate_api

# This auto-copies to:
# apps/cloud/src/api/generated/custom/
# apps/3d/src/api/generated/custom/
```

**Note:** Next.js dev server will auto-reload with new types!

---

## Related Documentation

- [packages/api/@docs/README.md](../../../packages/api/@docs/README.md) - CFG API package docs
- [packages/api/@docs/service-development.md](../../../packages/api/@docs/service-development.md) - Detailed service patterns
- [packages/api/@docs/error-handling.md](../../../packages/api/@docs/error-handling.md) - Error handling best practices
- [packages/api/@docs/best-practices.md](../../../packages/api/@docs/best-practices.md) - Critical rules
- [packages/api/@docs/architecture.md](../../../packages/api/@docs/architecture.md) - Package architecture

---

**Last Updated:** 2025-01-07
**App Version:** 1.0.0
**Status:** ✅ Production Ready

---

## Quick Reference

### CUSTOM Service Template

```typescript
import { BaseClient } from './BaseClient';
import type { MyTypes } from '../generated/custom';

export class MyService extends BaseClient {
  static async myMethod() {
    try {
      return await this.api.myEndpoint.myEndpointMethod();
    } catch (error) {
      return this.handleError(error, 'MyService.myMethod');
    }
  }
}
```

### CFG Service Reference

```typescript
// Use from @djangocfg/api package
import { AccountsService, PaymentsService } from '@djangocfg/api';
```
