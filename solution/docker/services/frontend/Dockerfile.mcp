# ═════════════════════════════════════════════════════════════════
# Django-CFG MCP Server
# Standalone MCP documentation server with vector search
#
# Uses PostgreSQL + pgvector for embeddings (no local SQLite)
# ═════════════════════════════════════════════════════════════════

FROM node:20-alpine AS base
WORKDIR /app

# ─────────────────────────────────────────────────────────────────
# Installer Stage - Install dependencies and build
# ─────────────────────────────────────────────────────────────────

FROM base AS installer
RUN corepack enable && corepack prepare pnpm@9.15.4 --activate

# Copy workspace configuration from frontend monorepo
COPY frontend/package.json ./
COPY frontend/pnpm-lock.yaml ./
COPY frontend/pnpm-workspace.yaml ./

# Copy ALL apps (needed for workspace resolution and docs content)
COPY frontend/apps ./apps

# Install dependencies
RUN pnpm install --frozen-lockfile

ENV NODE_ENV=production

# Build the MCP server
RUN cd apps/mcp && pnpm build

# ─────────────────────────────────────────────────────────────────
# Runner Stage - MCP Server (port 3002)
# ─────────────────────────────────────────────────────────────────

FROM node:20-alpine AS runner
RUN apk add --no-cache curl

ENV NODE_ENV=production
ENV PORT=3002
ENV HOST=0.0.0.0

# Create non-root user
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 mcpuser

WORKDIR /app

# Copy workspace configuration (needed for pnpm to resolve packages)
COPY --from=installer /app/package.json ./
COPY --from=installer /app/pnpm-lock.yaml ./
COPY --from=installer /app/pnpm-workspace.yaml ./

# Copy node_modules
COPY --from=installer /app/node_modules ./node_modules

# Copy the MCP app with build output
COPY --from=installer --chown=mcpuser:nodejs /app/apps/mcp ./apps/mcp

# Copy docs content for reindexing (from docs app)
COPY --from=installer --chown=mcpuser:nodejs /app/apps/docs/content ./docs-content

# Copy internal docs (hidden from site, indexed for AI)
# TODO: Restore when internal-docs directory is available
# COPY projects/django-cfg/src/internal-docs ./internal-docs

# Copy packages for UI component documentation (ButtonLink, etc.)
COPY --chown=mcpuser:nodejs frontend/packages/ui-core ./packages/ui-core
COPY --chown=mcpuser:nodejs frontend/packages/ui-nextjs ./packages/ui-nextjs
COPY --chown=mcpuser:nodejs frontend/packages/layouts ./packages/layouts
COPY --chown=mcpuser:nodejs frontend/packages/UI_GUIDE.md ./packages/UI_GUIDE.md

# Create entrypoint script inline
RUN printf '#!/bin/sh\nset -e\necho "Running database migrations..."\nnpx drizzle-kit push --force 2>/dev/null || echo "Warning: Migration failed"\necho "Starting MCP server..."\nexec "$@"\n' > /usr/local/bin/docker-entrypoint.sh && \
    chmod +x /usr/local/bin/docker-entrypoint.sh

USER mcpuser

EXPOSE 3002

HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3002/health || exit 1

# Run from the mcp app directory
WORKDIR /app/apps/mcp

ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]

# Start MCP server using tsx for hot-reload support
# When src/ is mounted via docker-compose, just restart container after code changes
# No rebuild needed - tsx compiles TypeScript on-the-fly
CMD ["npx", "tsx", "src/cli.ts", "serve", "--port", "3002"]
