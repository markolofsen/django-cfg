# Django CFG Sample Project - Makefile
#
# Local Development Workflow:
# 1. make install          ‚Üí Install from PyPI (production mode)
# 2. make install-local    ‚Üí Switch to local ~/djangocfg (editable)
#
# How it works:
# - pyproject.toml always has: django-cfg = {version = "*", extras = ["full"]}
# - install-local uses pip to override PyPI version with local editable install
# - No modifications to pyproject.toml or poetry.lock required!

.PHONY: help install install-local env test commit kill-ports kill-grpc kill-all dev dev-ngrok asgi grpc run-all manage migrate shell show-urls list-urls check-endpoints tree check config superuser api claude

# Python from virtual environment (poetry)
PYTHON := .venv/bin/python
POETRY := poetry
# Path to local django-cfg for development
DJANGO_CFG_LOCAL := $(HOME)/djangocfg

help:
	@echo "üöÄ Django Project - Make Commands"
	@echo ""
	@echo "Development:"
	@echo "  make dev       - Run dev server (port 8000)"
	@echo "  make asgi      - Run ASGI server (uvicorn)"
	@echo "  make grpc      - Run gRPC server (port 50051)"
	@echo "  make run-all   - Run ASGI + gRPC + RQ worker"
	@echo ""
	@echo "Management:"
	@echo "  make migrate   - Run migrations"
	@echo "  make shell     - Django shell"
	@echo "  make superuser - Create superuser"
	@echo "  make api       - Generate API clients"
	@echo ""
	@echo "RQ:"
	@echo "  make rq            - Start RQ worker (all queues)"
	@echo "  make rq-scheduler  - Start RQ scheduler"
	@echo "  make rq-clear      - Clear all RQ queues (Redis FLUSHDB)"
	@echo "  make rq-stats      - Show RQ statistics"
	@echo ""
	@echo "Cleanup:"
	@echo "  make kill-all  - Stop all services"
	@echo ""
	@echo "Other: install, install-local, test, commit, check, config"

install:
	@echo "üì¶ Installing dependencies (PyPI django-cfg)..."
	$(POETRY) install
	@echo "‚úÖ Installed django-cfg from PyPI"
	@echo "üí° To use local django-cfg: make install-local"

install-local:
	@bash -c ' \
		set -e; \
		eval "$$(conda shell.bash hook 2>/dev/null || true)"; \
		conda deactivate 2>/dev/null || true; \
		echo "üì¶ Updating lock file..."; \
		$(POETRY) lock; \
		echo "üì¶ Installing dependencies (production mode)..."; \
		$(POETRY) install; \
		echo "üì¶ Switching to local django-cfg..."; \
		echo "   Path: $(DJANGO_CFG_LOCAL)"; \
		test -d $(DJANGO_CFG_LOCAL) || (echo "‚ùå Error: $(DJANGO_CFG_LOCAL) not found" && exit 1); \
		echo "üîß Installing local django-cfg (editable mode)..."; \
		$(POETRY) run pip install -e "$(DJANGO_CFG_LOCAL)[full]"; \
		echo ""; \
		echo "‚úÖ Local django-cfg installed (editable mode)"; \
		echo "üìç Changes in $(DJANGO_CFG_LOCAL) will be immediately reflected"; \
	'

env:
	@$(POETRY) env info

test:
	$(PYTHON) manage.py test

commit:
	git add . && git commit && git push

kill-ports:
	lsof -i :8000 | awk 'NR>1 {print $$2}' | xargs kill -9 || true

kill-grpc:
	@echo "üî™ Killing all Django manage.py, gRPC and ASGI processes..."
	@# Kill ALL manage.py processes (runserver, rungrpc, shell, etc.)
	@pkill -9 -f "manage.py" 2>/dev/null || true
	@# Kill uvicorn processes
	@pkill -9 -f "uvicorn api.asgi" 2>/dev/null || true
	@# Kill by port (50051 - gRPC)
	@lsof -ti :50051 | xargs kill -9 2>/dev/null || true
	@# Kill by port (8000 - ASGI/Django)
	@lsof -ti :8000 | xargs kill -9 2>/dev/null || true
	@# Kill any Python processes still holding ports
	@lsof -ti :50051 -sTCP:LISTEN | xargs kill -9 2>/dev/null || true
	@lsof -ti :8000 -sTCP:LISTEN | xargs kill -9 2>/dev/null || true
	@# Small delay to ensure ports are released
	@sleep 0.5
	@echo "‚úÖ All Django processes, gRPC and ASGI killed"

kill-all:
	@echo "üî™ Killing ASGI, gRPC, and RQ worker processes..."
	@# Kill manage.py processes
	@pkill -9 -f "manage.py rungrpc" 2>/dev/null || true
	@pkill -9 -f "manage.py rqworker" 2>/dev/null || true
	@# Kill uvicorn
	@pkill -9 -f "uvicorn api.asgi" 2>/dev/null || true
	@# Kill by ports
	@lsof -ti :50051 | xargs kill -9 2>/dev/null || true
	@lsof -ti :8000 | xargs kill -9 2>/dev/null || true
	@sleep 0.5
	@echo "‚úÖ All services stopped"

dev: kill-ports
	$(PYTHON) manage.py runserver

dev-ngrok: kill-ports
	$(PYTHON) manage.py runserver_ngrok

asgi: kill-ports
	@echo "üåê Starting ASGI server on port 8000 (uvicorn)..."
	$(POETRY) run uvicorn api.asgi:application --host 0.0.0.0 --port 8000 --reload

grpc:
	@echo "üì° Starting gRPC server on port 50051..."
	@lsof -ti :50051 | xargs kill -9 2>/dev/null || true
	$(PYTHON) manage.py rungrpc --noreload

run-all: kill-all
	@echo "üöÄ Starting ASGI + gRPC + RQ worker..."
	@echo ""
	@bash -c ' \
		cleanup() { \
			echo ""; \
			echo "üõë Stopping all services..."; \
			pkill -9 -f "manage.py rungrpc" 2>/dev/null || true; \
			pkill -9 -f "manage.py rqworker" 2>/dev/null || true; \
			pkill -9 -f "uvicorn api.asgi" 2>/dev/null || true; \
			lsof -ti :50051 | xargs kill -9 2>/dev/null || true; \
			lsof -ti :8000 | xargs kill -9 2>/dev/null || true; \
			echo "‚úÖ All services stopped"; \
		}; \
		trap cleanup EXIT SIGINT SIGTERM; \
		echo "üì° Starting gRPC server on port 50051..."; \
		$(PYTHON) manage.py rungrpc --noreload & \
		GRPC_PID=$$!; \
		sleep 1; \
		echo "üåê Starting ASGI server on port 8000 (uvicorn)..."; \
		$(POETRY) run uvicorn api.asgi:application --host 0.0.0.0 --port 8000 --reload & \
		ASGI_PID=$$!; \
		sleep 1; \
		echo "üîÑ Starting RQ worker (all queues)..."; \
		OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES $(PYTHON) manage.py rqworker high default low --worker-class rq.SimpleWorker & \
		RQ_PID=$$!; \
		echo ""; \
		echo "‚úÖ All services started:"; \
		echo "   - gRPC:  http://localhost:50051 (PID: $$GRPC_PID)"; \
		echo "   - ASGI:  http://localhost:8000 (PID: $$ASGI_PID)"; \
		echo "   - RQ:    high, default, low queues (PID: $$RQ_PID)"; \
		echo ""; \
		echo "üí° Press Ctrl+C to stop all services"; \
		echo ""; \
		wait; \
	'

manage:
	$(PYTHON) manage.py $(CMD)

migrate:
	$(PYTHON) manage.py migrate_all

shell:
	$(PYTHON) manage.py shell

show-urls:
	$(PYTHON) manage.py show_urls

list-urls:
	$(PYTHON) manage.py list_urls

check-endpoints:
	$(PYTHON) manage.py check_endpoints

tree:
	$(PYTHON) manage.py tree

config:
	$(PYTHON) manage.py show_config

check:
	$(PYTHON) manage.py check

superuser:
	$(PYTHON) manage.py superuser

# API Generation
api:
	$(PYTHON) manage.py generate_api

# Start Claude Code with dangerously-skip-permissions flag
claude:
	claude --dangerously-skip-permissions --chrome

# RQ Workers and Scheduler (macOS optimized - uses SimpleWorker to prevent fork crashes)
rq: rq-clear
	@echo "üîÑ Starting RQ worker (high, default, low queues)..."
	@OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES $(PYTHON) manage.py rqworker high default low --worker-class rq.SimpleWorker

rq-scheduler:
	@echo "‚è∞ Starting RQ scheduler..."
	@$(PYTHON) manage.py rqscheduler

rq-clear:
	@echo "üóëÔ∏è  Clearing all RQ queues via Redis..."
	@redis-cli FLUSHDB
	@echo "‚úÖ All queues cleared"

rq-stats:
	@echo "üìä RQ Queue Statistics:"
	@$(PYTHON) manage.py rqstats
